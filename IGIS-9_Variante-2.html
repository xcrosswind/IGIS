<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!--The viewport meta tag is used to improve the presentation and behavior of the samples
      on iOS devices-->
<meta name="viewport"
    content="initial-scale=1, maximum-scale=1,user-scalable=no">
<title>Indigo GIS</title>
<link rel="stylesheet"
    href="https://js.arcgis.com/3.13/dijit/themes/tundra/tundra.css">
<link rel="stylesheet"
    href="https://js.arcgis.com/3.13/esri/css/esri.css">
<!-- für Map -->
<style>
html, body, #map, #mapDiv, .map.container {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
}

body {
    background-color: #FFF;
    overflow: hidden;
    font-family: "Trebuchet MS";
}

#legendDiv {
    background-color: #fff;
    position: absolute !important;
    z-index: 99;
    top: 10px;
    right: 20px;
}

#messages {
    background-color: #fff;
    box-shadow: 0 0 5px #888;
    font-size: 1.1em;
    max-width: 15em;
    padding: 0.5em;
    position: absolute;
    right: 20px;
    top: 20px;
    z-index: 40;
}
</style>
<script src="https://js.arcgis.com/3.13/"></script>
<script>
    var map;
    require(
            [ "esri/urlUtils", "esri/map", "esri/layers/FeatureLayer",
                    "esri/tasks/query", "esri/tasks/QueryTask",
                    "esri/geometry/Circle", "esri/graphic",
                    "esri/InfoTemplate", "esri/symbols/SimpleMarkerSymbol",
                    "esri/symbols/SimpleLineSymbol",
                    "esri/symbols/SimpleFillSymbol",
                    "esri/renderers/SimpleRenderer", "esri/config",
                    "esri/Color", "dojo/dom", "dojo/on", "dojo/domReady!",
                    "esri/arcgis/utils", "esri/dijit/Legend" ],
            function(urlUtils, Map, FeatureLayer, Query, QueryTask, Circle,
                    Graphic, InfoTemplate, SimpleMarkerSymbol,
                    SimpleLineSymbol, SimpleFillSymbol, SimpleRenderer,
                    esriConfig, Color, dom, on, arcgisUtils, Legend) {

                // erzeuge Karte
                map = new Map("mapDiv", {
                    basemap : "streets",
                    center : [ 7.445, 46.949 ],
                    zoom : 13,
                    slider : true
                });

                //add the points in on demand mode. Note that an info template has been defined so when
                //selected features are clicked a popup window will appear displaying the content defined in the info template.
                var featureLayer = new FeatureLayer(
                        "https://stgeo01/arcgis/rest/services//Indigo/v_gis_station_selex/MapServer/0",
                        {
                            infoTemplate : new InfoTemplate("Block: ${BLOCK}",
                                    "${*}"),
                            outFields : [ "user_id", "active_guid",
                                    "stat_code", "stat_name", "services" ]
                        });

                var queryTask = new esri.tasks.QueryTask(
                        "https://stgeo01/arcgis/rest/services//Indigo/v_gis_station_selex/MapServer/0");
                //build query filter
                var query = new esri.tasks.Query();
                query.returnGeometry = true;
                query.outFields = [ "user_id", "active_guid", "stat_code",
                        "stat_name", "services" ];
        
        // Die URL liefert die user_id und die active_guid. Damit können die beiden Parameter aus der URL ausgelesen werden.
        // das Package esri/urlUtils muss als erstes aufgeführt werden. Warum ist unklar.
                var url = document.location.href;
                var myObject = urlUtils.urlToObject(url);

                query.where = "user_id = " + myObject.query['user_id']
                        + " AND active_guid = '"
                        + myObject.query['active_guid'] + "'"; // hier SQL WHERE Clause definieren

                queryTask.execute(query, initResults);

                function initResults(response) {
                    featureLayer.selectFeatures(query,
                            FeatureLayer.SELECTION_NEW, function(results) {
                            });
                }

                // selection symbol used to draw the selected points within the buffer polygon
                var symbol = new SimpleMarkerSymbol(
                        SimpleMarkerSymbol.STYLE_CIRCLE, 14,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL,
                                new Color([ 247, 34, 101, 0.9 ]), 1),
                        new Color([ 207, 34, 171, 0.5 ]));
                featureLayer.setSelectionSymbol(symbol);

                //make unselected features invisible
                var unselectSymbol = new SimpleMarkerSymbol(
                        SimpleMarkerSymbol.STYLE_CIRCLE, 4,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL,
                                new Color([ 247, 34, 101, 0.9 ]), 1),
                        new Color([ 207, 34, 171, 0.5 ]));
                featureLayer.setRenderer(new SimpleRenderer(unselectSymbol));

                map.addLayer(featureLayer);

                var circleSymb = new SimpleFillSymbol(
                        SimpleFillSymbol.STYLE_NULL, new SimpleLineSymbol(
                                SimpleLineSymbol.STYLE_SHORTDASHDOTDOT,
                                new Color([ 105, 105, 105 ]), 2), new Color([
                                255, 255, 0, 0.25 ]));
                var circle;
            });
</script>
</head>
<body>
    <div id="mapDiv"></div>
</body>
</html>