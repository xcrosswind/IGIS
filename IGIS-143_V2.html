<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!--The viewport meta tag is used to improve the presentation and behavior of the samples
      on iOS devices-->
<meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
<title>Indigo GIS</title>
<link rel="stylesheet" href="https://js.arcgis.com/3.13/dijit/themes/claro/claro.css">
<link rel="stylesheet" href="https://js.arcgis.com/3.13/esri/css/esri.css">
<style>
body {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    background-color: #FFF;
    overflow: hidden;
    font-family: "Trebuchet MS";
}

html, #map {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
}
    

</style>
<script src="https://js.arcgis.com/3.13/"></script>
<script>
    var map;
    
    require(
            [ "esri/urlUtils"
                , "esri/map"
                , "esri/layers/FeatureLayer"
                , "esri/symbols/SimpleMarkerSymbol" 
                , "esri/symbols/SimpleLineSymbol"
                , "esri/symbols/SimpleFillSymbol"
                , "esri/renderers/SimpleRenderer"
                , "esri/Color"

                , "esri/tasks/query"
                , "esri/tasks/QueryTask"   
                , "esri/arcgis/utils"      
                
                , "dojo/dom"
                , "dojo/on"    
                , "dojo/parser"
                , "dojo/domReady!"
                    ],
                    
            function(urlUtils
                , Map
                , FeatureLayer
                , SimpleMarkerSymbol
                , SimpleLineSymbol
                , SimpleFillSymbol
                , SimpleRenderer
                , Color
                
                , Query
                , QueryTask
                , arcgisUtils
                
                , dom
                , on
                , parser
                 ) {
                parser.parse();
                
                // create map 
                map = new Map("map", {
                    basemap : "hybrid", // Alternativen: satellite, streets, terrain, topo (siehe https://developers.arcgis.com/javascript/jsapi/esri.basemaps-amd.html)
                                        // welche Basemap sinnvoll ist, muss noch nicht den Anwendern diskutiert werden
                    slider : true   
                });
                
                var mapServiceUrl = "https://stgeo01/arcgis/rest/services/Indigo/IGIS_V_GIS_STATION2_WGS84N/MapServer/0";
                
                var featureLayer = new FeatureLayer(
                  mapServiceUrl, 
         
                  {  outFields : ["STAT_ID", "STAT_CODE", "STAT_NAME","OFFERER_ID", "LON", "LAT", "REGION_ID", 
                                    "GROUND_LEVEL", "CREA_DATE", "OFFERER_TYPE", "IS_GSM", "IS_DCS", "IS_UMTS", "IS_LTE", "IS_OUTD", "IS_INHOUS", "IS_TUNNEL" ]
                        }      
                );
                 
                // lies STAT_CODE aus URL
                var url = urlUtils.urlToObject(document.location.href);
                featureLayer.setDefinitionExpression("STAT_CODE = '" + url.query["STAT_CODE"] + "'");
             
                // Symbolisierung
                var symbol = new SimpleMarkerSymbol(
                        SimpleMarkerSymbol.STYLE_CIRCLE, 14,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL,
                                new Color([ 247, 34, 101, 0.9 ]), 1),
                        new Color([ 255, 0, 0, 1 ]));
                
         
                featureLayer.setRenderer(new SimpleRenderer(symbol));
                map.addLayer(featureLayer);
                
                // Idee: ich setze mit der setDefinitionExpression genau einen Punkt.
                // danach extrahiere ich die Koordinaten aus den Daten und zoome auf diesen Punkt.
                // Wie komme ich weiter?
                
                
                
                var query = new Query();
                query.outFields = ["STAT_ID", "STAT_CODE", "STAT_NAME","OFFERER_ID", "LON", "LAT", "REGION_ID", 
                                    "GROUND_LEVEL", "CREA_DATE", "OFFERER_TYPE", "IS_GSM", "IS_DCS", "IS_UMTS", "IS_LTE", "IS_OUTD", "IS_INHOUS", "IS_TUNNEL" ];
      
                query.where = "STAT_CODE = 'BELB'";
                
                featureLayer.queryFeatures(query);
                console.log(featureLayer.selectFeatures(query));
            //    featureLayer.features;
                
               /* 
                function selectInBuffer(response){
                  var feature;
                  var features = response.features;
                  var inBuffer = [];
                  //filter out features that are not actually in buffer, since we got all points in the buffer's bounding box
                for (var i = 0; i < features.length; i++) {
                  feature = features[i];
                  if(circle.contains(feature.geometry)){
                    inBuffer.push(feature.attributes[featureLayer.objectIdField]);
                }
                }
               var query = new Query();
                    query.objectIds = inBuffer;
                  //use a fast objectIds selection query (should not need to go to the server)
                  featureLayer.selectFeatures(query, FeatureLayer.SELECTION_NEW, function(results){
                  var totalPopulation = sumPopulation(results);
                  var r = "";
                   r = "<b>The total Census Block population within the buffer is <i>" + totalPopulation + "</i>.</b>";
                    dom.byId("messages").innerHTML = r;
                  });
                 }
                */
                
                
                
              //  console.log(featureLayer.getSelectedFeatures());
                
                
                
                
              // warum kann ich hier nicht Attribute aus dem Objekt auslesen?
              // es sind noch potenziell mehrere Attribute. Ich müsste also irgendwie durch den Array selektieren.
             
      /*        var query = new Query();
              query.returnGeometry = true;
                            
               var url = document.location.href;
               var myObject = urlUtils.urlToObject(url);
                                           
               // ?stat_code=BELB  
               query.where = "stat_code = '"
                        + myObject.query['STAT_CODE']                         // Bsp. BELB, BEEL
                        + "'"; 
                
                featureLayer.selectFeatures(query, FeatureLayer.SELECTION_NEW);
                */
               
       //         console.log(featureLayer.getSelectedFeatures());
                
                
         //       map.addLayer(featureLayer); 
                
                
                
                                 
                    // identifiziere die Koordinaten aus dem Objekt
      /*              var pos_long = featureSet.features[0].attributes.LON;
                    var pos_lat = featureSet.features[0].attributes.LAT;
                    
                    console.log(pos_long);
                    console.log(pos_lat);
                    
            //     map.centerAndZoom(new Point(pos_long, pos_lat), 16);  */
                 

      /*          var symbol = new SimpleMarkerSymbol(
                        SimpleMarkerSymbol.STYLE_CIRCLE, 14,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL,
                                new Color([ 247, 34, 101, 0.9 ]), 1),
                        new Color([ 255, 0, 0, 1 ]));
                featureLayer.setSelectionSymbol(symbol);
                
                //make unselected features invisible
                // ??? besser wäre, wenn man diese Symbole gar nicht erst laden könnte
                var nullSymbol = new SimpleMarkerSymbol().setSize(0);
                featureLayer.setRenderer(new SimpleRenderer(nullSymbol));
                */
                    //       console.log(featureLayer.count());
 
          //      console.log(featureLayer.dataAttributes);
                
           //     var pos_long = featureLayer.fields[0].attributes.LON;
             //   var pos_lat = featureLayer.fields[0].attributes.LAT;
                
               // console.log(pos_long);
                
                
              //  map.centerAndZoom(new Point(pos_long, pos_lat), 16); 

 });
</script>
</head>

<body class="claro">
  <div id="map"></div>
</body>
</html>


